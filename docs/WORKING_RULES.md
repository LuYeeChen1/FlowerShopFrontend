# WORKING_RULES.md
# AI / Codex 工作规则（必须遵守）

本文件定义 Codex 在本项目中执行任务的工作方式。**必须严格遵守**。  
目标：把“大任务”拆成**多个高质量、小范围、可验证**的功能切片（Feature Slice），并且**代码质量优先于文件数量与进度**。

---

## 0) 总原则（最高优先级）

### 0.1 代码质量优先于文件数量
- 宁可多切几次、每次更小，也不允许为了“赶进度 / 少文件”牺牲：
    - 可读性
    - 正确性
    - 清晰的职责边界
- **不为凑文件而写代码**；如果高质量实现需要更多文件，允许新增，但必须合理且有必要。

### 0.2 每次只交付 1 个功能切片（Feature Slice）
- 一个切片必须：
    - 能独立解释
    - 能独立验证（至少能编译 / 能跑最小验证）
- **不允许一次输出多个切片**
- 后续切片必须等待用户明确继续指令。

### 0.3 遵守冻结事实（硬约束）
- ❌ 不允许改已冻结的 Cloud / Group 设计
- ❌ 不允许引入新云服务 / 新角色
- ❌ 不允许 Lambda 访问 MySQL
- ❌ 不允许 Backend 直接操作 Cognito Group  
  （如需改组：**只能通过既定云端链路 / 既定 Lambda**）

---

## 0.4 质量优先的授权声明（关键）

> 本条用于**消除 Codex 顾虑**，允许其为了质量主动拆分与调整。

- 我的唯一目标：**让 Codex 以「代码质量优先」的前提下执行任务**。
- 我明确允许 Codex：
    - 将一份**大任务拆分为任意多个小切片（Feature Slice）**
    - 为了质量与可维护性，对实现方式做**较大结构性调整**
        - 例如：重排文件、抽取类、补齐边界层接口、调整依赖方向
- 但前提是：
    - **不触碰任何已冻结的 Cloud / Group / 权限边界**
    - **仍然严格遵守本文件所有严禁事项**
    - **每次输出仍然只能是 1 个切片**

---

## 0.5 “最简单”的官方定义（防止误解）

- “最简单”**不等于**：
    - 最少文件
    - 把多个职责塞进一个类
    - 省略必要的边界层
- “最简单”指：
    - 最少分支
    - 最少隐式规则
    - 最低耦合
    - 最清晰的职责归属

> 若“最简单实现”与“代码质量”冲突，**必须以代码质量为准**。

---

## 1) 交付粒度（Feature Slice）

- 每次输出：**1 个切片**
- 文件数量建议：**3–8 个文件**

### 超过 8 个文件时
- 必须拆分为 **Part 1 / Part 2（或更多）**
- 并且：
    - **先交付 Part 1**
    - Part 1 必须：
        - 能编译
        - 能做最小验证
- 未完成的 Part 2 不允许提前输出。

---

## 2) 每个切片必须包含的交付内容（缺一不可）

### A. 修改 / 新增文件清单
- 按完整路径列出所有文件
- 标注：
    - 新增
    - 修改
    - 删除（尽量避免删除）

### B. 每个文件的完整内容
- **必须是完整文件**
- ❌ 不接受 diff
- ❌ 不接受片段
- ❌ 不接受 TODO 占位
- 保证可直接 Copy & Paste 覆盖。

### C. 最小运行 / 验证说明
至少包含：
- 如何触发该切片
    - HTTP 请求 / curl / Postman / 简单 main / 测试
- 预期结果是什么

> 说明必须**简短、明确、可操作**。

---

## 3) 切片拆分策略（Codex 必须主动执行）

当用户给出“大任务”时，Codex **必须先在内部拆分**，并且：

- **只输出第 1 个切片**
- 不得把多个切片混在同一次输出中

### 拆分优先级
1. **最小闭环**（能跑 / 能验证）
2. 再补齐**管理或扩展能力**
3. 最后才是**优化 / 增强**
    - 日志
    - 审计
    - 细化错误码

### 拆分原则
- 一个切片只解决 **一个可验证目标**
- 不跨越 Clean Architecture 边界：
    - domain
    - application
    - interfaces
    - infrastructure
- ❌ 不把未来切片的代码提前塞进当前切片。

---

## 4) 质量门槛（Quality Gate）

每个切片在输出前必须自检。  
**任何一项不满足，就必须继续拆小或重写。**

### 4.1 可读性
- 命名清晰
- 职责单一
- 符合 Clean Architecture 依赖方向
- Controller **不包含业务逻辑**

### 4.2 正确性
- 关键流程无未定义行为
- 错误处理一致、可预测
    - 例如：400 / 401 / 403 / 409 等

### 4.3 可维护性
- Normalize / Rules / Pipeline **逻辑集中**
- 不允许散落在 Controller / Service 中
- 依赖注入清晰、边界明确

### 4.4 可验证性
- 至少提供一种最小验证方式
- 不要求完美测试覆盖
- 但**主路径必须可验证**

---

## 5) 严禁事项（再次强调）

- ❌ 改已冻结的 Cloud / Group 设计
- ❌ 引入新云服务 / 新角色
- ❌ Lambda 访问 MySQL
- ❌ Backend 直接操作 Cognito Group
- ❌ 一次输出多个切片
- ❌ 只给伪代码 / 只给片段 / 只给 TODO
- ❌ 为了少文件把多个职责塞进一个类

---

## 6) 推荐切片顺序（Seller Onboarding）

遵循：**最小闭环 → 管理闭环 → 可选扩展**

1. **Seller Submit 最小闭环**
    - POST 提交
    - 写入 Onboarding（DynamoDB 或本地存储抽象）
    - 返回 OnboardingResponse
    - 身份来源：JWT `sub`

2. **Admin Review 最小闭环**
    - Admin 拉取待审列表（基于状态）
    - Approve / Reject 更新状态
    - 写 Review Log（append-only）

3. **S3 Presign（可选）**
    - 生成 presigned upload URL
    - confirm 后写 Document 元数据
    - Admin 可对 Document 做 verified / rejected

> 所有步骤必须：
> - 0 成本
> - 不违反 Backend 不直接操作 Cognito Group 的原则

---

## 7) 超负荷处理（防止质量下降）

当 Codex 判断当前切片会导致：
- 输出过长
- 复杂度过高
- 质量不可控

必须主动：
1. **缩小切片目标**
2. 或拆分为 Part 1 / Part 2
3. 并**优先交付可编译 / 可验证的 Part 1**

---

## 8) 输出格式约定（强制）

每次输出必须严格按以下结构：

1. 标题  
   `[Slice X] <切片名称>`
2. 文件清单（新增 / 修改）
3. 文件完整内容（逐个文件）
4. 最小验证说明（步骤 + 预期结果）

---

## 9) 解释权与冲突处理

- 若本文件与其他文档冲突：
    - 以**更严格 / 更保守 / 更符合冻结原则**的规则为准
- 若用户的新指令与本文件冲突：
    - **必须停止**
    - 明确指出冲突条款
    - 等待用户修正指令
